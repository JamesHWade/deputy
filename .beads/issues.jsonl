{"id":"deputy-0d9","title":"Expand dangerous bash command patterns","description":"hook_block_dangerous_bash() has limited pattern coverage.\n\n**Current patterns:**\n- rm -rf, sudo, chmod 777, mkfs, dd if=, \u003e /dev/\n\n**Missing dangerous patterns:**\n- Fork bombs: :(){ :|: \u0026};:\n- eval and backticks\n- Command substitution $()\n- Network commands (nc, telnet, curl POST)\n- Environment manipulation\n\n**Files:**\n- R/hooks.R (lines 434-441)","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-09T07:00:17.971952-05:00","created_by":"james","updated_at":"2026-01-09T07:00:17.971952-05:00"}
{"id":"deputy-0zv","title":"Add hook timeout and multi-agent delegation tests","description":"Missing test coverage for:\n\n**Hook timeouts:**\n- Timeout behavior when callr runs hook\n- Hook callback timeout failure recovery\n\n**Multi-agent delegation:**\n- Sub-agent errors and recovery\n- Unknown agent name handling\n- Model mismatch scenarios\n- Skill loading failures in sub-agents\n\n**Files:**\n- tests/testthat/test-hooks.R\n- tests/testthat/test-agents-multi.R","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-09T06:59:52.291888-05:00","created_by":"james","updated_at":"2026-01-09T06:59:52.291888-05:00"}
{"id":"deputy-6k6","title":"Review implementation parity with claude-agent-sdk","description":"Compare deputy implementation against claude-agent-sdk (Python) to ensure feature parity and identify gaps.\n\n**Areas to review:**\n\n1. **Hook System**\n   - Event types (PreToolUse, PostToolUse, Stop, UserPromptSubmit, PreCompact)\n   - Hook result types and fields\n   - Hook matching patterns\n\n2. **Permission System**\n   - Permission modes (default, acceptEdits, readonly, bypassPermissions)\n   - Permission callbacks\n   - Tool annotation support\n\n3. **Agent Execution**\n   - Streaming vs batch execution\n   - Turn limits, cost limits\n   - Interruption handling\n\n4. **Multi-Agent**\n   - Agent definitions\n   - Delegation patterns\n   - Model inheritance\n\n5. **Missing Features**\n   - Any SDK features not yet in deputy\n   - API differences that may cause confusion\n\n**Repository:** https://github.com/anthropics/claude-agent-sdk","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T07:04:23.188389-05:00","created_by":"james","updated_at":"2026-01-09T11:08:10.204448-05:00","closed_at":"2026-01-09T11:08:10.204448-05:00","close_reason":"## Implementation Parity Review: deputy vs claude-code-sdk-python\n\n### Architecture Difference\n\n| Aspect | claude-code-sdk-python | deputy |\n|--------|----------------------|--------|\n| **Core** | Wraps Claude Code CLI (subprocess) | Wraps ellmer (R library) |\n| **Communication** | JSON over stdio | Direct R function calls |\n| **Async model** | Python async/await | coro generators |\n\nThe SDK is a CLI wrapper; deputy is a library wrapper. Different approaches, both valid.\n\n---\n\n### Hook System Comparison\n\n**Hook Events:**\n| Event | SDK | deputy | Notes |\n|-------|-----|--------|-------|\n| PreToolUse | ✅ | ✅ | |\n| PostToolUse | ✅ | ✅ | |\n| UserPromptSubmit | ✅ | ✅ | |\n| Stop | ✅ | ✅ | |\n| PreCompact | ✅ | ✅ | |\n| **SubagentStop** | ✅ | ❌ | **GAP** - fires when sub-agent completes |\n\n**Hook Capabilities:**\n| Feature | SDK | deputy | Notes |\n|---------|-----|--------|-------|\n| Allow/deny tools | ✅ | ✅ | |\n| **Input modification** | ✅ | ❌ | **GAP** - SDK can return `updatedInput` |\n| **System message injection** | ✅ | ❌ | **GAP** - SDK can return `systemMessage` |\n| **Output suppression** | ✅ | ❌ | **GAP** - SDK has `suppressOutput` |\n| Timeout support | ✅ | ✅ | deputy uses callr |\n| Pattern matching | ✅ | ✅ | Both use regex |\n\n---\n\n### Permission System Comparison\n\n**Permission Modes:**\n| Mode | SDK | deputy | Notes |\n|------|-----|--------|-------|\n| default | ✅ | ✅ | |\n| acceptEdits | ✅ | ✅ | |\n| bypassPermissions | ✅ | ✅ | |\n| **plan** | ✅ | ❌ | SDK-only mode for planning |\n| **readonly** | ❌ | ✅ | deputy-only mode |\n\n**Permission Features:**\n| Feature | SDK | deputy | Notes |\n|---------|-----|--------|-------|\n| can_use_tool callback | ✅ | ✅ | |\n| PermissionResultAllow/Deny | ✅ | ✅ | |\n| **Dynamic permission updates** | ✅ | ❌ | **GAP** - SDK has PermissionUpdate |\n| Fine-grained controls | Limited | ✅ | deputy has file_read, file_write, bash, r_code, web |\n| Tool annotations | Implicit | ✅ | deputy uses read_only_hint, destructive_hint |\n| Cost limits | ✅ | ✅ | max_cost_usd |\n| Turn limits | ✅ | ✅ | max_turns |\n\n---\n\n### Multi-Agent Comparison\n\n| Feature | SDK | deputy |\n|---------|-----|--------|\n| Agent definitions | ✅ AgentDefinition | ✅ agent_definition() |\n| Delegation mechanism | Via options | Via delegate_to_agent tool |\n| Model inheritance | ✅ | ✅ |\n| Sub-agent tools | ✅ | ✅ |\n| Sub-agent permissions | Inherited | Inherited |\n\n**deputy's approach is more explicit** - uses a tool for delegation that the LLM must call, rather than SDK's config-based approach.\n\n---\n\n### Features deputy Has That SDK Doesn't Emphasize\n\n1. **R code sandbox** - callr-based isolation for tool_run_r_code\n2. **Hook timeout via callr** - Enforced timeouts in subprocess\n3. **readonly mode** - Explicit read-only permission mode\n4. **Tool annotation handling** - Detailed read_only_hint, destructive_hint, open_world_hint\n5. **LLM-based compaction** - Uses LLM to summarize compacted turns\n6. **Skill system** - SKILL.yaml + SKILL.md loading\n\n---\n\n### Gaps to Consider Addressing\n\n**Priority 1 - Important:**\n| Gap | Description | Effort |\n|-----|-------------|--------|\n| SubagentStop hook | Fire hook when sub-agent completes | Low |\n| Input modification | Allow PreToolUse hooks to modify tool_input | Medium |\n\n**Priority 2 - Nice to Have:**\n| Gap | Description | Effort |\n|-----|-------------|--------|\n| System message injection | Hooks can inject messages into conversation | Medium |\n| Dynamic permission updates | Modify permissions mid-conversation | Medium |\n| Session forking | Branch conversation state | High |\n\n**Not Needed:**\n- plan mode (deputy's readonly + hooks serve similar purpose)\n- Output suppression (not critical for R use cases)\n\n---\n\n### Recommendations\n\n1. **Add SubagentStop hook event** - Easy win, useful for logging/metrics\n2. **Consider input modification** - Useful but adds complexity\n3. **Keep current permission approach** - deputy's fine-grained controls are actually more powerful\n4. **Don't chase full parity** - Different architectures, different strengths\n\ndeputy has feature parity where it matters, with some R-specific improvements (sandboxing, hooks). The SDK has some nice-to-haves (input modification, message injection) that could be added later if needed."}
{"id":"deputy-7jd","title":"Improve documentation for hooks and tool annotations","description":"Several documentation gaps identified:\n\n**Hook context:**\n- Document what's in the context parameter for each hook type\n- Add examples showing context structure\n\n**Tool annotations:**\n- Central documentation of all available annotations\n- read_only_hint, destructive_hint, open_world_hint\n- Default values and effects\n\n**Compaction:**\n- Document how summaries are generated\n- PreCompact hook timing clarification\n\n**Files:**\n- R/hooks.R\n- R/permissions.R\n- R/agent.R\n- man/*.Rd","status":"open","priority":4,"issue_type":"task","created_at":"2026-01-09T07:00:33.585111-05:00","created_by":"james","updated_at":"2026-01-09T07:00:33.585111-05:00"}
{"id":"deputy-90o","title":"Validate skill provider requirements","description":"Skills can specify provider requirements in SKILL.yaml but these aren't validated.\n\n**Current:**\n- Only package requirements are checked (lines 71-77 in skills.R)\n\n**Expected:**\n- Validate that required providers (openai, anthropic, etc.) are available\n- Warn or error if skill is loaded without required provider\n\n**Files:**\n- R/skills.R","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-09T07:00:00.99337-05:00","created_by":"james","updated_at":"2026-01-09T07:00:00.99337-05:00"}
{"id":"deputy-e0u","title":"Detect skill tool name conflicts","description":"When loading skills, tool name conflicts are silently overwritten.\n\n**Current:**\n- Lines 446-448 in skills.R silently overwrite tools with same name\n\n**Expected:**\n- Warn on duplicate tool names\n- Consider erroring or providing conflict resolution options\n\n**Files:**\n- R/skills.R","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-09T07:00:07.66083-05:00","created_by":"james","updated_at":"2026-01-09T07:00:07.66083-05:00"}
{"id":"deputy-emf","title":"Implement LLM-based conversation compaction","description":"The compact() method in agent.R currently uses simple text concatenation instead of LLM summarization.\n\n**Current behavior:**\n- Lines 502-504 in agent.R use basic text joining\n- Produces poor summaries that lose important context\n\n**Expected behavior:**\n- Use LLM to generate meaningful conversation summaries\n- Preserve key context and decisions from compacted turns\n\n**Files:**\n- R/agent.R (compact method)","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-09T06:59:17.427567-05:00","created_by":"james","updated_at":"2026-01-09T07:09:29.75468-05:00","closed_at":"2026-01-09T07:09:29.75468-05:00","close_reason":"Implemented LLM-based compaction with fallback"}
{"id":"deputy-nhj","title":"Add tool result type validation","description":"The on_tool_result callback has minimal validation of tool result structure.\n\n**Risk:**\n- Malformed ContentToolResult objects could crash the agent\n\n**Files:**\n- R/agent.R (on_tool_result callback, lines 602-635)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-09T06:59:43.864784-05:00","created_by":"james","updated_at":"2026-01-09T06:59:43.864784-05:00"}
{"id":"deputy-p15","title":"Add S7 Turn mock support for generator tests","description":"Current mock chat doesn't provide proper S7 Turn objects that the generator expects.\n\n**Impact:**\n- Generator tests are superficial\n- Can't validate turn event generation properly\n\n**Solution:**\n- Create sophisticated mock that returns proper ellmer Turn objects\n- Or use vcr to record/replay real API responses\n\n**Files:**\n- tests/testthat/helper-mocks.R\n- tests/testthat/test-agent-execution.R","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-09T06:59:26.558881-05:00","created_by":"james","updated_at":"2026-01-09T06:59:26.558881-05:00"}
{"id":"deputy-sy6","title":"Examine posit-dev/btw for tool reuse opportunities","description":"Review the posit-dev/btw repository for inspiration and potential tool reuse.\n\n**Goals:**\n- Identify tools in btw that could be reused or adapted\n- Compare tool implementations and patterns\n- Evaluate if we can depend on btw directly vs copying/adapting\n- Look for patterns we're missing\n\n**Areas to examine:**\n- File operation tools\n- Code execution tools\n- Data analysis tools\n- Any R-specific tooling patterns\n\n**Repository:** https://github.com/posit-dev/btw","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T07:04:12.841644-05:00","created_by":"james","updated_at":"2026-01-09T08:04:12.604955-05:00","closed_at":"2026-01-09T08:04:12.604955-05:00","close_reason":"## btw Repository Analysis Complete\n\n### Overview\nposit-dev/btw is a tool-providing package for ellmer with 17+ specialized tools organized into categories: docs, env, eval, files, git, github, ide, pkg, search, session, web.\n\n### Key Patterns Worth Adopting\n\n1. **Rich Tool Descriptions**: btw uses detailed descriptions with \"WHEN TO USE\" sections that guide LLM tool selection. We should adopt this pattern for clarity.\n\n2. **Tool Grouping System**: `btw_tools(\"category\")` pattern is elegant. We have similar with `tools_file()` etc.\n\n3. **BtwToolResult S7 Class**: Extends ContentToolResult with structured output. Our tools return plain strings - could consider richer result types.\n\n4. **GitHub API Validation**: Sophisticated endpoint allow/block system with wildcard patterns. If we add GitHub tools, this is a good security model.\n\n### Tools We Could Adapt\n\n| btw Tool | Deputy Opportunity |\n|----------|-------------------|\n| **git tools** (via gert) | Add `tools_git()` - branch, commit, diff, log operations |\n| **documentation tools** | Add `tool_read_help()`, `tool_list_vignettes()` |\n| **environment tools** | Add `tool_inspect_object()`, `tool_list_packages()` |\n| **GitHub tools** | Add `tools_github()` with endpoint validation pattern |\n\n### What NOT to Adopt\n\n1. **No Sandboxing**: btw's `tool_r_run()` executes R directly without sandbox. We keep our callr-based sandbox - it's more secure for untrusted tasks.\n\n2. **chromote Dependency**: btw's web tool requires chromote (headless Chrome). Heavy dependency we don't need.\n\n3. **IDE Integration**: btw's IDE tools are RStudio/Positron specific. Not needed for our CLI-focused approach.\n\n### Recommendation\n\n**Don't depend on btw directly** - different security philosophies. Instead:\n- Adapt their tool description patterns (more detailed WHEN TO USE sections)\n- Consider adding git tools using gert (low effort, high value)\n- Consider documentation tools (R help system integration)\n- Keep our sandbox approach - it differentiates deputy as more secure\n\n### Priority for New Tools\n1. P3: Git tools via gert (most requested)\n2. P4: Documentation tools (help/vignettes)\n3. P4: Environment inspection tools"}
{"id":"deputy-z0g","title":"Improve symlink and path traversal handling","description":"Path validation has edge cases that aren't fully handled.\n\n**Issues:**\n- Relative symlinks that escape directories not blocked\n- Home directory expansion (~) could bypass restrictions\n- Symlink chains not fully resolved\n- Race conditions between check and use (TOCTOU)\n\n**Files:**\n- R/utils.R (is_path_within, has_path_traversal)\n- R/permissions.R","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-09T06:59:34.976206-05:00","created_by":"james","updated_at":"2026-01-09T06:59:34.976206-05:00"}
