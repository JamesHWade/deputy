<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Example: Shiny Chat with shinychat • deputy</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example: Shiny Chat with shinychat">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">deputy</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/tools.html">Tools and Tool Bundles</a></li>
    <li><a class="dropdown-item" href="../articles/permissions.html">Permissions and Safety</a></li>
    <li><a class="dropdown-item" href="../articles/hooks.html">Hooks</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/multi-agent.html">Multi-Agent Orchestration</a></li>
    <li><a class="dropdown-item" href="../articles/structured-output.html">Structured Output</a></li>
    <li><a class="dropdown-item" href="../articles/agent-configuration.html">Agent Configuration</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Examples</h6></li>
    <li><a class="dropdown-item" href="../articles/example-data-analysis.html">Data Analysis Agent</a></li>
    <li><a class="dropdown-item" href="../articles/example-extraction-pipeline.html">Extraction Pipeline</a></li>
    <li><a class="dropdown-item" href="../articles/example-code-review.html">Code Review (Multi-Agent)</a></li>
    <li><a class="dropdown-item" href="../articles/example-shiny-chat.html">Shiny Chat</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/JamesHWade/deputy/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Example: Shiny Chat with shinychat</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/JamesHWade/deputy/blob/main/vignettes/example-shiny-chat.Rmd" class="external-link"><code>vignettes/example-shiny-chat.Rmd</code></a></small>
      <div class="d-none name"><code>example-shiny-chat.Rmd</code></div>
    </div>

    
    
<p>This example shows how to use deputy with <a href="https://posit-dev.github.io/shinychat/" class="external-link">shinychat</a> to build an
interactive chat application with permissions, hooks, and tool call
limits.</p>
<div class="section level2">
<h2 id="the-problem">The Problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>shinychat’s <code><a href="https://posit-dev.github.io/shinychat/r/reference/chat_append.html" class="external-link">chat_append()</a></code> expects an ellmer content
stream from <code>chat$stream_async()</code>. Deputy’s
<code>run()</code> and <code>run_sync()</code> methods return
<code>AgentEvent</code> objects instead. Calling
<code>agent$chat$stream_async()</code> directly works but bypasses
deputy’s turn-level controls like <code>max_turns</code> and
<code>max_cost_usd</code>.</p>
<p><code>run_shiny()</code> bridges this gap: it returns a content
stream that shinychat understands while still enforcing deputy’s
permissions, hooks, and limits.</p>
</div>
<div class="section level2">
<h2 id="what-run_shiny-enforces">What <code>run_shiny()</code> Enforces<a class="anchor" aria-label="anchor" href="#what-run_shiny-enforces"></a>
</h2>
<table class="table">
<colgroup>
<col width="33%">
<col width="33%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Feature</th>
<th>Enforced?</th>
<th>How</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Permissions (file_read, bash, etc.)</td>
<td>Yes</td>
<td>
<code>on_tool_request</code> callback</td>
</tr>
<tr class="even">
<td>PreToolUse / PostToolUse hooks</td>
<td>Yes</td>
<td>
<code>on_tool_request</code> / <code>on_tool_result</code>
callbacks</td>
</tr>
<tr class="odd">
<td>Tool call limit</td>
<td>Yes</td>
<td>Counter in <code>on_tool_request</code>, rejects with graceful
message</td>
</tr>
<tr class="even">
<td>Cost limit (<code>max_cost_usd</code>)</td>
<td>Yes</td>
<td>Checked in <code>on_tool_request</code>
</td>
</tr>
<tr class="odd">
<td>SessionStart / SessionEnd hooks</td>
<td>Yes</td>
<td>Fired before/after the stream</td>
</tr>
<tr class="even">
<td>Stall detection</td>
<td>No</td>
<td>Requires deputy’s own loop</td>
</tr>
<tr class="odd">
<td>
<code>output_format</code> (structured output)</td>
<td>No</td>
<td>Requires deputy’s own loop</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="basic-setup">Basic Setup<a class="anchor" aria-label="anchor" href="#basic-setup"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/JamesHWade/deputy" class="external-link">deputy</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://posit-dev.github.io/shinychat/r/" class="external-link">shinychat</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">bslib</span><span class="fu">::</span><span class="fu"><a href="https://rstudio.github.io/bslib/reference/page.html" class="external-link">page_fluid</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://posit-dev.github.io/shinychat/r/reference/chat_ui.html" class="external-link">chat_ui</a></span><span class="op">(</span><span class="st">"chat"</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu">ellmer</span><span class="fu">::</span><span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_openai.html" class="external-link">chat_openai</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="st">"gpt-4o-mini"</span>,</span>
<span>    system_prompt <span class="op">=</span> <span class="st">"You are a helpful assistant. Be concise."</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">agent</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Agent.html">Agent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    chat <span class="op">=</span> <span class="va">chat</span>,</span>
<span>    tools <span class="op">=</span> <span class="fu"><a href="../reference/tools_file.html">tools_file</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">chat_user_input</span>, <span class="op">{</span></span>
<span>    <span class="va">stream</span> <span class="op">&lt;-</span> <span class="va">agent</span><span class="op">$</span><span class="fu">run_shiny</span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">chat_user_input</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://posit-dev.github.io/shinychat/r/reference/chat_append.html" class="external-link">chat_append</a></span><span class="op">(</span><span class="st">"chat"</span>, <span class="va">stream</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/shinyApp.html" class="external-link">shinyApp</a></span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="with-permissions-and-hooks">With Permissions and Hooks<a class="anchor" aria-label="anchor" href="#with-permissions-and-hooks"></a>
</h2>
<p>Deputy’s permissions and hooks fire on every tool call, even though
shinychat drives the streaming loop:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chat</span> <span class="op">&lt;-</span> <span class="fu">ellmer</span><span class="fu">::</span><span class="fu"><a href="https://ellmer.tidyverse.org/reference/chat_anthropic.html" class="external-link">chat_anthropic</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="st">"claude-sonnet-4-5-20250929"</span>,</span>
<span>    system_prompt <span class="op">=</span> <span class="st">"You are a data analyst. Be concise."</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">agent</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/Agent.html">Agent</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    chat <span class="op">=</span> <span class="va">chat</span>,</span>
<span>    tools <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/tools_file.html">tools_file</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/tools_data.html">tools_data</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    permissions <span class="op">=</span> <span class="va"><a href="../reference/Permissions.html">Permissions</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>      file_read <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      file_write <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      r_code <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      bash <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      max_cost_usd <span class="op">=</span> <span class="fl">0.50</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Hooks still fire normally</span></span>
<span>  <span class="va">agent</span><span class="op">$</span><span class="fu">add_hook</span><span class="op">(</span><span class="fu"><a href="../reference/hook_log_tools.html">hook_log_tools</a></span><span class="op">(</span>verbose <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/shiny/man/observeEvent.html" class="external-link">observeEvent</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">chat_user_input</span>, <span class="op">{</span></span>
<span>    <span class="co"># max_tool_calls limits how many tool calls the agent can make</span></span>
<span>    <span class="va">stream</span> <span class="op">&lt;-</span> <span class="va">agent</span><span class="op">$</span><span class="fu">run_shiny</span><span class="op">(</span></span>
<span>      <span class="va">input</span><span class="op">$</span><span class="va">chat_user_input</span>,</span>
<span>      max_tool_calls <span class="op">=</span> <span class="fl">10</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="https://posit-dev.github.io/shinychat/r/reference/chat_append.html" class="external-link">chat_append</a></span><span class="op">(</span><span class="st">"chat"</span>, <span class="va">stream</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="how-limits-work">How Limits Work<a class="anchor" aria-label="anchor" href="#how-limits-work"></a>
</h2>
<p>When a tool call limit or cost limit is reached, deputy calls
<code><a href="https://ellmer.tidyverse.org/reference/tool_reject.html" class="external-link">ellmer::tool_reject()</a></code> with a message asking the LLM to wrap
up. The LLM receives this as a tool error and generates a final
response. The user sees a complete, coherent message rather than a
truncated stream.</p>
<p>The <code>max_tool_calls</code> parameter counts individual tool call
requests, not LLM turns. One turn can include multiple parallel tool
calls (e.g., the LLM reads three files at once), each counting
separately. This is more precise than turn counting for controlling
resource usage.</p>
</div>
<div class="section level2">
<h2 id="running-the-example">Running the Example<a class="anchor" aria-label="anchor" href="#running-the-example"></a>
</h2>
<p>A complete example app is included in the package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">shiny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/shiny/man/runApp.html" class="external-link">runApp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/shiny-chat"</span>, package <span class="op">=</span> <span class="st">"deputy"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James Wade.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
